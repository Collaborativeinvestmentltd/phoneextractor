<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard - Data Extractor</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --secondary: #7209b7;
      --success: #4cc9f0;
      --danger: #f72585;
      --warning: #f8961e;
      --info: #4895ef;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --gray-light: #e9ecef;
      --border-radius: 8px;
      --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: var(--dark);
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Header Styles */
    .main-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: white;
      padding: 20px 30px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      margin-bottom: 25px;
    }

    .main-header h1 {
      color: var(--primary);
      font-size: 1.8rem;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .admin-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .admin-name {
      font-weight: 600;
      color: var(--dark);
    }

    /* Button Styles */
    .btn {
      padding: 10px 15px;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: var(--transition);
      text-decoration: none;
      font-size: 0.9rem;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .primary-btn {
      background-color: var(--primary);
      color: white;
    }

    .primary-btn:hover {
      background-color: var(--primary-dark);
    }

    .success-btn {
      background-color: var(--success);
      color: white;
    }

    .danger-btn {
      background-color: var(--danger);
      color: white;
    }

    .warning-btn {
      background-color: var(--warning);
      color: white;
    }

    .info-btn {
      background-color: var(--info);
      color: white;
    }

    .outline-btn {
      background-color: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
    }

    /* Flash Messages */
    .flash-messages {
      margin-bottom: 20px;
    }

    .flash {
      padding: 12px 20px;
      border-radius: var(--border-radius);
      margin-bottom: 10px;
      font-weight: 500;
    }

    .flash.success {
      background-color: rgba(76, 201, 240, 0.2);
      color: var(--success);
      border: 1px solid var(--success);
    }

    .flash.error {
      background-color: rgba(247, 37, 133, 0.2);
      color: var(--danger);
      border: 1px solid var(--danger);
    }

    /* Stats Panel */
    .stats-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .stat-box {
      background: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      text-align: center;
      transition: var(--transition);
    }

    .stat-box:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
    }

    .stat-box h3 {
      font-size: 0.9rem;
      color: var(--gray);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--primary);
    }

    /* Accordion Styles */
    .accordion {
      width: 100%;
      background: white;
      color: var(--dark);
      cursor: pointer;
      padding: 18px 20px;
      border: none;
      text-align: left;
      outline: none;
      font-size: 1.1rem;
      font-weight: 600;
      border-radius: var(--border-radius);
      margin-bottom: 10px;
      box-shadow: var(--box-shadow);
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: var(--transition);
    }

    .accordion:hover {
      background-color: var(--gray-light);
    }

    .accordion.active {
      border-bottom-left-radius: 0;
      border-bottom-right-radius: 0;
      margin-bottom: 0;
    }

    .accordion i {
      transition: var(--transition);
    }

    .accordion.active i {
      transform: rotate(180deg);
    }

    .accordion-content {
      padding: 0;
      background-color: white;
      border-bottom-left-radius: var(--border-radius);
      border-bottom-right-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      margin-bottom: 20px;
      overflow: hidden;
      max-height: 0;
      transition: max-height 0.3s ease-out;
    }

    .accordion-content.active {
      max-height: 1000px;
      padding: 20px;
    }

    /* Form Styles */
    .form-section {
      margin-bottom: 20px;
    }

    .form-row {
      display: flex;
      gap: 15px;
      align-items: flex-end;
      flex-wrap: wrap;
    }

    .form-group {
      flex: 1;
      min-width: 200px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--dark);
    }

    input, select, textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--gray-light);
      border-radius: var(--border-radius);
      font-size: 1rem;
      transition: var(--transition);
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
    }

    /* Table Styles */
    .search-box {
      width: 100%;
      margin-bottom: 15px;
      position: relative;
    }

    .search-box i {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray);
    }

    .search-box input {
      padding-left: 40px;
    }

    .results-container {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid var(--gray-light);
      border-radius: var(--border-radius);
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table th {
      background-color: var(--primary);
      color: white;
      position: sticky;
      top: 0;
      padding: 15px;
      text-align: left;
      font-weight: 600;
    }

    .data-table td {
      padding: 12px 15px;
      border-bottom: 1px solid var(--gray-light);
    }

    .data-table tr:nth-child(even) {
      background-color: #f8f9fa;
    }

    .data-table tr:hover {
      background-color: #e9ecef;
    }

    .monospace {
      font-family: 'Courier New', Courier, monospace;
      font-size: 0.9rem;
    }

    /* Status Indicators */
    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .status-active {
      background-color: rgba(76, 201, 240, 0.2);
      color: var(--success);
    }

    .status-expired {
      background-color: rgba(248, 150, 30, 0.2);
      color: var(--warning);
    }

    .status-revoked {
      background-color: rgba(247, 37, 133, 0.2);
      color: var(--danger);
    }

    /* Log Container */
    .log-container {
      background: #1a1a1a;
      color: #00ff88;
      font-family: 'Courier New', Courier, monospace;
      height: 300px;
      overflow-y: auto;
      padding: 15px;
      border-radius: var(--border-radius);
      border: 1px solid #333;
    }

    .log-controls {
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 15px;
    }

    .log-controls .search-box {
      margin-bottom: 0;
      flex: 1;
    }

    .log-entry {
      padding: 5px 0;
      border-bottom: 1px dashed #333;
      font-size: 0.9rem;
      line-height: 1.4;
    }

    .log-entry.error {
      color: #ff6b6b;
    }

    .log-entry.warning {
      color: #ffd93d;
    }

    .log-entry.info {
      color: #4cc9f0;
    }

    /* Action Buttons */
    .action-buttons {
      display: flex;
      gap: 8px;
    }

    .btn-sm {
      padding: 6px 10px;
      font-size: 0.8rem;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .main-header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }

      .stats-panel {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      }

      .form-row {
        flex-direction: column;
      }

      .form-group {
        min-width: 100%;
      }

      .log-controls {
        flex-direction: column;
      }
    }

    /* Loading Animation */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="main-header">
      <h1><i class="fas fa-cogs"></i> Admin Dashboard</h1>
      <div class="admin-info">
        <span class="admin-name"><i class="fas fa-user"></i> Logged in as: <b>{{ current_user }}</b></span>
        <a href="{{ url_for('admin_logout') }}" class="btn danger-btn">
          <i class="fas fa-sign-out-alt"></i> Logout
        </a>
      </div>
    </header>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-messages">
          {% for category, message in messages %}
            <div class="flash {{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- Stats Dashboard -->
    <div class="stats-panel">
      <div class="stat-box">
        <h3><i class="fas fa-satellite-dish"></i> Active Extraction</h3>
        <div class="stat-value">{{ 'Yes' if extraction_active else 'No' }}</div>
      </div>
      <div class="stat-box">
        <h3><i class="fas fa-phone"></i> Extracted Numbers</h3>
        <div class="stat-value">{{ extracted_count }}</div>
      </div>
      <div class="stat-box">
        <h3><i class="fas fa-users"></i> Registered Users</h3>
        <div class="stat-value">{{ user_count }}</div>
      </div>
      <div class="stat-box">
        <h3><i class="fas fa-key"></i> Total Licenses</h3>
        <div class="stat-value">{{ licenses|length }}</div>
      </div>
      <div class="stat-box">
        <h3><i class="fas fa-clock"></i> Server Time</h3>
        <div class="stat-value" id="server-time">{{ now.strftime('%H:%M') }}</div>
      </div>
    </div>

    <!-- License Management -->
    <button class="accordion" id="license-accordion">
      <span><i class="fas fa-key"></i> License Management</span>
      <i class="fas fa-chevron-down"></i>
    </button>
    <div class="accordion-content" id="license-content">
      <div class="form-section">
        <h3><i class="fas fa-plus-circle"></i> Generate New License</h3>
        <form action="{{ url_for('generate_license') }}" method="POST" class="form-row">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="form-group">
            <label for="expiry_days"><i class="fas fa-calendar-times"></i> Expiry Days (optional)</label>
            <input type="number" id="expiry_days" name="expiry_days" min="1" placeholder="Leave empty for no expiry">
          </div>
          <button type="submit" class="btn primary-btn">
            <i class="fas fa-key"></i> Generate License
          </button>
        </form>
      </div>

      <div class="form-section">
        <h3><i class="fas fa-list"></i> License List</h3>
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" id="licenseSearch" placeholder="Search licenses...">
        </div>
        <div class="results-container">
          <table class="data-table" id="licenseTable">
            <thead>
              <tr>
                <th><i class="fas fa-key"></i> License Key</th>
                <th><i class="fas fa-calendar-plus"></i> Created</th>
                <th><i class="fas fa-calendar-times"></i> Expires</th>
                <th><i class="fas fa-chart-bar"></i> Usage</th>
                <th><i class="fas fa-info-circle"></i> Status</th>
                <th><i class="fas fa-cog"></i> Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for lic in licenses %}
              <tr>
                <td class="monospace">{{ lic.key }}</td>
                <td>{{ lic.created_at.strftime('%Y-%m-%d') if lic.created_at else 'N/A' }}</td>
                <td>{{ lic.expiry.strftime('%Y-%m-%d') if lic.expiry else 'No expiry' }}</td>
                <td>{{ lic.usage_count }} times</td>
                <td>
                  {% set is_expired = false %}
                  {% if lic.expiry %}
                    {% if lic.expiry.tzinfo is none %}
                      {% set expiry_aware = lic.expiry.replace(tzinfo=timezone.utc) %}
                    {% else %}
                      {% set expiry_aware = lic.expiry %}
                    {% endif %}
                    {% set is_expired = expiry_aware < now %}
                  {% endif %}
                  <span class="status-indicator {% if lic.revoked %}status-revoked{% elif is_expired %}status-expired{% else %}status-active{% endif %}">
                    <i class="fas fa-{% if lic.revoked %}ban{% elif is_expired %}exclamation-triangle{% else %}check-circle{% endif %}"></i>
                    {{ 'Revoked' if lic.revoked else 'Expired' if is_expired else 'Active' }}
                  </span>
                </td>
                <td>
                  <div class="action-buttons">
                    {% if not lic.revoked %}
                    <form method="POST" action="{{ url_for('revoke_license', license_key=lic.key) }}" style="display:inline;">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <button type="submit" class="btn danger-btn btn-sm" onclick="return confirm('Are you sure you want to revoke this license?')">
                        <i class="fas fa-ban"></i> Revoke
                      </button>
                    </form>
                    {% endif %}
                    <button class="btn info-btn btn-sm" onclick="copyToClipboard('{{ lic.key }}')">
                      <i class="fas fa-copy"></i> Copy
                    </button>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- User Management -->
    <button class="accordion" id="user-accordion">
      <span><i class="fas fa-users"></i> User Management</span>
      <i class="fas fa-chevron-down"></i>
    </button>
    <div class="accordion-content" id="user-content">
      <div class="form-section">
        <h3><i class="fas fa-user-plus"></i> Add New User</h3>
        <form action="/add-user" method="POST" class="form-row">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="form-group">
            <label for="username"><i class="fas fa-user"></i> Username</label>
            <input type="text" id="username" name="username" placeholder="Enter username" required>
          </div>
          <div class="form-group">
            <label for="password"><i class="fas fa-lock"></i> Password</label>
            <input type="password" id="password" name="password" placeholder="Enter password" required>
          </div>
          <div class="form-group">
            <label for="email"><i class="fas fa-envelope"></i> Email (optional)</label>
            <input type="email" id="email" name="email" placeholder="Enter email">
          </div>
          <button type="submit" class="btn success-btn">
            <i class="fas fa-user-plus"></i> Add User
          </button>
        </form>
      </div>

      <div class="form-section">
        <h3><i class="fas fa-list"></i> User List</h3>
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" id="userSearch" placeholder="Search users...">
        </div>
        <div class="results-container">
          <table class="data-table" id="userTable">
            <thead>
              <tr>
                <th><i class="fas fa-user"></i> Username</th>
                <th><i class="fas fa-envelope"></i> Email</th>
                <th><i class="fas fa-calendar-plus"></i> Created</th>
                <th><i class="fas fa-sign-in-alt"></i> Last Login</th>
                <th><i class="fas fa-info-circle"></i> Status</th>
                <th><i class="fas fa-cog"></i> Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for user in users %}
              <tr>
                <td>{{ user.username }}</td>
                <td>{{ user.email or 'N/A' }}</td>
                <td>{{ user.created_at.strftime('%Y-%m-%d') if user.created_at else 'N/A' }}</td>
                <td>{{ user.last_login.strftime('%Y-%m-%d %H:%M') if user.last_login else 'Never' }}</td>
                <td>
                  <span class="status-indicator {% if user.is_active %}status-active{% else %}status-revoked{% endif %}">
                    <i class="fas fa-{% if user.is_active %}check-circle{% else %}ban{% endif %}"></i>
                    {{ 'Active' if user.is_active else 'Inactive' }}
                  </span>
                </td>
                <td>
                  <div class="action-buttons">
                    <a href="{{ url_for('edit_user', username=user.username) }}" class="btn success-btn btn-sm">
                      <i class="fas fa-edit"></i> Edit
                    </a>
                    <form method="POST" action="{{ url_for('delete_user', username=user.username) }}" style="display:inline;">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <button type="submit" class="btn danger-btn btn-sm" onclick="return confirm('Are you sure you want to delete this user?')">
                        <i class="fas fa-trash"></i> Delete
                      </button>
                    </form>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- System Logs -->
    <button class="accordion" id="logs-accordion">
      <span><i class="fas fa-terminal"></i> System Logs</span>
      <i class="fas fa-chevron-down"></i>
    </button>
    <div class="accordion-content" id="logs-content">
      <div class="log-controls">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" id="logSearch" placeholder="Filter logs...">
        </div>
        <div class="action-buttons">
          <button id="toggleLogsBtn" class="btn warning-btn" onclick="toggleLogs()">
            <i class="fas fa-pause"></i> Pause
          </button>
          <button class="btn info-btn" onclick="fetchLogs()">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
          <button class="btn danger-btn" onclick="clearLogs()">
            <i class="fas fa-trash"></i> Clear
          </button>
        </div>
      </div>
      <div id="logContainer" class="log-container">
        <div class="log-entry">[ System initialized - waiting for log data... ]</div>
      </div>
    </div>
  </div>

  <script>
    // Global variables
    let logInterval;
    let logsPaused = false;

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize accordions
      initAccordions();
      
      // Start log updates
      logInterval = setInterval(fetchLogs, 2000);
      
      // Initialize search functionality
      initSearch();
      
      // Update server time every minute
      setInterval(updateServerTime, 60000);
    });

    // Accordion functionality
    function initAccordions() {
      const accordions = document.querySelectorAll('.accordion');
      
      accordions.forEach(accordion => {
        accordion.addEventListener('click', function() {
          this.classList.toggle('active');
          const content = this.nextElementSibling;
          content.classList.toggle('active');
        });
      });
    }

    // Search functionality
    function initSearch() {
      // License search
      document.getElementById('licenseSearch').addEventListener('input', function() {
        filterTable('licenseSearch', 'licenseTable');
      });
      
      // User search
      document.getElementById('userSearch').addEventListener('input', function() {
        filterTable('userSearch', 'userTable');
      });
    }

    function filterTable(inputId, tableId) {
      const input = document.getElementById(inputId);
      const filter = input.value.toLowerCase();
      const table = document.getElementById(tableId);
      const rows = table.getElementsByTagName('tr');
      
      for (let i = 1; i < rows.length; i++) {
        const cells = rows[i].getElementsByTagName('td');
        let show = false;
        
        for (let j = 0; j < cells.length; j++) {
          if (cells[j].textContent.toLowerCase().includes(filter)) {
            show = true;
            break;
          }
        }
        
        rows[i].style.display = show ? '' : 'none';
      }
    }

    // Log management
    function fetchLogs() {
      if (logsPaused) return;
      
      fetch("/admin/logs")
        .then(response => response.json())
        .then(data => {
          const logContainer = document.getElementById("logContainer");
          const filter = document.getElementById("logSearch").value.toLowerCase();
          logContainer.innerHTML = "";
          
          if (data.logs && data.logs.length > 0) {
            data.logs.forEach(line => {
              if (!filter || line.toLowerCase().includes(filter)) {
                const div = document.createElement("div");
                div.className = "log-entry";
                
                // Add styling based on log level
                if (line.toLowerCase().includes('error')) {
                  div.classList.add('error');
                } else if (line.toLowerCase().includes('warning')) {
                  div.classList.add('warning');
                } else if (line.toLowerCase().includes('info')) {
                  div.classList.add('info');
                }
                
                div.textContent = line;
                logContainer.appendChild(div);
              }
            });
          } else {
            logContainer.innerHTML = '<div class="log-entry">[ No log entries available ]</div>';
          }
          
          logContainer.scrollTop = logContainer.scrollHeight;
        })
        .catch(error => {
          console.error("Error fetching logs:", error);
          document.getElementById("logContainer").innerHTML = 
            '<div class="log-entry error">[ Error fetching logs ]</div>';
        });
    }

    function toggleLogs() {
      logsPaused = !logsPaused;
      const button = document.getElementById("toggleLogsBtn");
      button.innerHTML = logsPaused ? 
        '<i class="fas fa-play"></i> Resume' : 
        '<i class="fas fa-pause"></i> Pause';
      button.className = logsPaused ? 
        'btn success-btn' : 
        'btn warning-btn';
    }

    function clearLogs() {
      document.getElementById("logContainer").innerHTML = 
        '<div class="log-entry">[ Logs cleared ]</div>';
    }

    // Utility functions
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(function() {
        // Show temporary success message
        const originalText = event.target.innerHTML;
        event.target.innerHTML = '<i class="fas fa-check"></i> Copied!';
        setTimeout(() => {
          event.target.innerHTML = originalText;
        }, 2000);
      }).catch(function(err) {
        console.error('Could not copy text: ', err);
      });
    }

    function updateServerTime() {
      const now = new Date();
      document.getElementById('server-time').textContent = 
        now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    // Auto-expand first accordion
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('license-accordion').click();
    });
  </script>
</body>
</html>