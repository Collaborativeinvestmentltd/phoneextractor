<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="csrf-token" content="{{ csrf_token() }}">
  <title>Professional Data Extractor</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --secondary: #7209b7;
      --success: #4cc9f0;
      --danger: #f72585;
      --warning: #f8961e;
      --info: #4895ef;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --gray-light: #e9ecef;
      --border-radius: 8px;
      --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: var(--dark);
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Header Styles */
    .main-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: white;
      padding: 20px 30px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      margin-bottom: 25px;
      flex-wrap: wrap;
      border-left: 4px solid var(--primary);
    }

    .main-header h1 {
      color: var(--primary);
      font-size: 2rem;
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 700;
    }

    .header-controls {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    /* Button Styles */
    .btn {
      padding: 12px 18px;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: var(--transition);
      text-decoration: none;
      font-size: 0.95rem;
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }

    .primary-btn {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
    }

    .primary-btn:hover {
      background: linear-gradient(135deg, var(--primary-dark), var(--primary));
    }

    .success-btn {
      background: linear-gradient(135deg, var(--success), #38b2ac);
      color: white;
    }

    .danger-btn {
      background: linear-gradient(135deg, var(--danger), #e11d48);
      color: white;
    }

    .warning-btn {
      background: linear-gradient(135deg, var(--warning), #ea580c);
      color: white;
    }

    .admin-btn {
      background: linear-gradient(135deg, var(--secondary), #6b21a8);
      color: white;
    }

    .outline-btn {
      background: transparent;
      border: 2px solid var(--primary);
      color: var(--primary);
    }

    /* Form Styles */
    .form-section {
      background: white;
      padding: 25px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      margin-bottom: 20px;
      border-left: 3px solid var(--primary);
      transition: var(--transition);
    }

    .form-section:hover {
      box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
    }

    .form-section h3 {
      color: var(--primary);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.2rem;
    }

    .form-section label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--dark);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .input-group {
      margin-bottom: 20px;
    }

    input, select, textarea {
      width: 100%;
      padding: 14px;
      border: 2px solid var(--gray-light);
      border-radius: var(--border-radius);
      font-size: 1rem;
      transition: var(--transition);
      font-family: inherit;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
      transform: translateY(-1px);
    }

    textarea {
      min-height: 120px;
      resize: vertical;
      line-height: 1.5;
    }

    .helper {
      display: block;
      margin-top: 6px;
      color: var(--gray);
      font-size: 0.85rem;
      font-style: italic;
    }

    /* Enhanced Checkbox Group */
    .checkbox-group {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 12px;
      margin-top: 10px;
    }

    .checkbox-group label {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 500;
      cursor: pointer;
      padding: 12px;
      border-radius: var(--border-radius);
      transition: var(--transition);
      border: 2px solid transparent;
      background: var(--light);
    }

    .checkbox-group label:hover {
      background: var(--gray-light);
      transform: translateY(-2px);
      border-color: var(--primary);
    }

    .checkbox-group input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--primary);
    }

    /* Enhanced Results Section */
    .results-section {
      background: white;
      padding: 25px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      margin-top: 20px;
      border-left: 3px solid var(--success);
    }

    .results-section h2 {
      margin-bottom: 20px;
      color: var(--success);
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.4rem;
    }

    .results-container {
      max-height: 500px;
      overflow-y: auto;
      border: 2px solid var(--gray-light);
      border-radius: var(--border-radius);
      position: relative;
    }

    .results-container::-webkit-scrollbar {
      width: 8px;
    }

    .results-container::-webkit-scrollbar-track {
      background: var(--gray-light);
      border-radius: 4px;
    }

    .results-container::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 4px;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
    }

    .data-table th {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      position: sticky;
      top: 0;
      padding: 15px 12px;
      text-align: left;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.85rem;
      letter-spacing: 0.5px;
    }

    .data-table td {
      padding: 12px;
      border-bottom: 1px solid var(--gray-light);
      vertical-align: top;
    }

    .data-entry:nth-child(even) {
      background-color: #f8f9fa;
    }

    .data-entry:hover {
      background-color: #e3f2fd;
      transform: scale(1.01);
      transition: var(--transition);
    }

    .placeholder-msg {
      text-align: center;
      color: var(--gray);
      padding: 40px 20px;
      font-style: italic;
    }

    .progress-stats {
      margin-top: 20px;
      padding: 15px;
      background: linear-gradient(135deg, var(--light), var(--gray-light));
      border-radius: var(--border-radius);
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .stats-group {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }

    .stat-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
    }

    /* Enhanced Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(5px);
    }

    .modal-content {
      background: white;
      max-width: 500px;
      width: 90%;
      padding: 30px;
      border-radius: var(--border-radius);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      animation: modalSlideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      border-top: 4px solid var(--primary);
    }

    @keyframes modalSlideIn {
      from { 
        opacity: 0; 
        transform: translateY(-50px) scale(0.9); 
      }
      to { 
        opacity: 1; 
        transform: translateY(0) scale(1); 
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--gray-light);
    }

    .modal-header h2 {
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.4rem;
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 1.8rem;
      cursor: pointer;
      color: var(--gray);
      transition: var(--transition);
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }

    .close-modal:hover {
      color: var(--danger);
      background: var(--gray-light);
    }

    /* Enhanced Toast Notification */
    .toast {
      position: fixed;
      top: 30px;
      right: 30px;
      padding: 18px 24px;
      border-radius: var(--border-radius);
      color: white;
      z-index: 1100;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      gap: 12px;
      transform: translateX(150%);
      transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      max-width: 400px;
      border-left: 4px solid;
    }

    .toast.show {
      transform: translateX(0);
    }

    .toast.success {
      background: var(--success);
      border-left-color: #38b2ac;
    }

    .toast.error {
      background: var(--danger);
      border-left-color: #e11d48;
    }

    .toast.warning {
      background: var(--warning);
      border-left-color: #ea580c;
    }

    /* Enhanced Status Indicators */
    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-active {
      background: linear-gradient(135deg, rgba(76, 201, 240, 0.2), rgba(56, 178, 172, 0.2));
      color: var(--success);
      border: 1px solid var(--success);
    }

    .status-inactive {
      background: rgba(108, 117, 125, 0.1);
      color: var(--gray);
      border: 1px solid var(--gray);
    }

    /* Enhanced Extraction Panel */
    .extraction-panel {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 20px;
      margin-top: 25px;
      max-height: 400px;
      overflow-y: auto;
      border-left: 3px solid var(--info);
    }

    .extraction-panel h3 {
      color: var(--info);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .extracted-item {
      padding: 15px;
      border-bottom: 1px solid var(--gray-light);
      display: flex;
      align-items: center;
      gap: 12px;
      transition: var(--transition);
      border-left: 3px solid transparent;
    }

    .extracted-item:hover {
      background: var(--light);
      border-left-color: var(--success);
      transform: translateX(5px);
    }

    .extracted-item:last-child {
      border-bottom: none;
    }

    /* Quick Actions Panel */
    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }

    .action-card {
      background: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
      border-top: 4px solid var(--primary);
    }

    .action-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }

    .action-card i {
      font-size: 2rem;
      color: var(--primary);
      margin-bottom: 10px;
    }

    /* Loading Animation */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Pulse animation for active extraction */
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(76, 201, 240, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(76, 201, 240, 0); }
      100% { box-shadow: 0 0 0 0 rgba(76, 201, 240, 0); }
    }

    .extracting-pulse {
      animation: pulse 2s infinite;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }

      .main-header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
        padding: 15px 20px;
      }

      .header-controls {
        justify-content: center;
      }

      .checkbox-group {
        grid-template-columns: 1fr;
      }

      .quick-actions {
        grid-template-columns: 1fr;
      }

      .data-table {
        font-size: 0.85rem;
      }

      .data-table th, .data-table td {
        padding: 8px 6px;
      }

      .stats-group {
        flex-direction: column;
        gap: 10px;
      }

      .toast {
        right: 15px;
        left: 15px;
        max-width: none;
      }
    }

    @media (max-width: 480px) {
      .btn {
        padding: 10px 12px;
        font-size: 0.85rem;
      }

      .form-section {
        padding: 15px;
      }

      .modal-content {
        padding: 20px;
      }
    }

    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
      body {
        background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
        color: #e2e8f0;
      }

      .form-section, .results-section, .extraction-panel, .action-card {
        background: #2d3748;
        color: #e2e8f0;
      }

      input, select, textarea {
        background: #4a5568;
        border-color: #718096;
        color: #e2e8f0;
      }

      .checkbox-group label {
        background: #4a5568;
      }

      .data-entry:nth-child(even) {
        background-color: #4a5568;
      }

      .data-entry:hover {
        background-color: #5a6578;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <header class="main-header">
      <h1><i class="fas fa-search"></i> Professional Data Extractor</h1>
      <div class="header-controls">
        <button class="btn success-btn" onclick="exportData()">
          <i class="fas fa-download"></i> Export CSV
        </button>
        <button class="btn danger-btn" onclick="stopExtraction()">
          <i class="fas fa-stop"></i> Stop Extraction
        </button>
        <a href="{{ url_for('admin_login') }}" class="btn admin-btn">
            <i class="fas fa-cog"></i> Admin Panel
        </a>
        <button class="btn primary-btn" id="user-login-btn">
          <i class="fas fa-key"></i> User Login
        </button>
        <button class="btn warning-btn" id="user-logout-btn" style="display:none;">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </header>

    <!-- Quick Actions -->
    <div class="quick-actions">
      <div class="action-card" onclick="$('#keywords').focus()">
        <i class="fas fa-bolt"></i>
        <h4>Quick Start</h4>
        <p>Begin extraction instantly</p>
      </div>
      <div class="action-card" onclick="$('#license-key').focus(); $('#user-login-btn').click();">
        <i class="fas fa-rocket"></i>
        <h4>Fast Login</h4>
        <p>Quick license access</p>
      </div>
      <div class="action-card" onclick="updateResults()">
        <i class="fas fa-sync-alt"></i>
        <h4>Refresh Data</h4>
        <p>Update results view</p>
      </div>
    </div>

    <!-- License Login Modal -->
    <div id="license-login" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2><i class="fas fa-key"></i> User License Login</h2>
          <button class="close-modal">&times;</button>
        </div>
        <form id="license-form">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="input-group">
            <label for="license-key"><i class="fas fa-id-card"></i> Enter Your License Key:</label>
            <input type="text" id="license-key" name="license_key" placeholder="XXXX-XXXX-XXXX-XXXX" required>
            <small class="helper">Enter your valid license key to access extraction features</small>
          </div>
          <button type="submit" class="btn primary-btn" style="width: 100%;">
            <i class="fas fa-sign-in-alt"></i> Login & Start Extracting
          </button>
        </form>
        <div id="license-error" style="color: var(--danger); margin-top: 15px; text-align: center; font-weight: 500;"></div>
      </div>
    </div>

    <!-- Main Form -->
    <form method="POST" id="phone-extractor-form">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      
      <div class="form-section">
        <h3><i class="fas fa-search"></i> Search Parameters</h3>
        <div class="input-group">
          <label for="keywords"><i class="fas fa-key"></i> Keywords (optional):</label>
          <textarea name="keywords" id="keywords" placeholder="restaurants, plumbing services, healthcare providers&#10;Specific business types, categories, or names"></textarea>
          <small class="helper">Keywords help narrow down search results. Leave blank for broader search.</small>
        </div>
      </div>

      <div class="form-section">
        <h3><i class="fas fa-sitemap"></i> Data Sources</h3>
        <label>Select platforms to extract data from:</label>
        <div class="checkbox-group">
            <label><input type="checkbox" name="platforms[]" value="yellowpages" checked> 
                <i class="fas fa-book"></i> Yellow Pages <span class="status-indicator status-active">REAL</span>
            </label>
            <label><input type="checkbox" name="platforms[]" value="whitepages" checked> 
                <i class="fas fa-book-open"></i> Whitepages <span class="status-indicator status-active">REAL</span>
            </label>
            <label><input type="checkbox" name="platforms[]" value="manta"> 
                <i class="fas fa-fish"></i> Manta <span class="status-indicator status-active">REAL</span>
            </label>
            <label><input type="checkbox" name="platforms[]" value="yelp" checked> 
                <i class="fas fa-utensils"></i> Yelp <span class="status-indicator status-active">REAL</span>
            </label>
            <label><input type="checkbox" name="platforms[]" value="truepeoplesearch"> 
                <i class="fas fa-user"></i> TruePeopleSearch <span class="status-indicator status-active">REAL</span>
            </label>
            <label><input type="checkbox" name="platforms[]" value="spokeo"> 
                <i class="fas fa-search"></i> Spokeo <span class="status-indicator status-active">REAL</span>
            </label>
            <label><input type="checkbox" name="platforms[]" value="fastpeoplesearch"> 
                <i class="fas fa-bolt"></i> FastPeopleSearch <span class="status-indicator status-active">REAL</span>
            </label>
            <label><input type="checkbox" name="platforms[]" value="zabasearch"> 
                <i class="fas fa-globe"></i> ZabaSearch <span class="status-indicator status-active">REAL</span>
            </label>
        </div>
        <small class="helper">Selected platforms will be scanned for business information and contact details</small>
      </div>

      <div class="form-section">
        <h3><i class="fas fa-globe-americas"></i> Geographic Targeting</h3>
        <div class="input-group">
          <label for="country"><i class="fas fa-flag"></i> Select Country:</label>
          <select id="country" name="country">
            <option value="">-- Select Country --</option>
            {% for country in countries %}
              <option value="{{ country }}">{{ country }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="input-group">
          <label for="state"><i class="fas fa-map-marked-alt"></i> Select State / Region (optional):</label>
          <select id="state" name="state">
            <option value="">-- Select State --</option>
          </select>
          <small class="helper">Specify region for more targeted results. Country selection is required.</small>
        </div>
      </div>
      
      <div class="form-section" style="text-align: center; background: linear-gradient(135deg, #f8f9fa, #e9ecef);">
        <button type="button" class="btn primary-btn" onclick="startExtraction()" style="padding: 15px 40px; font-size: 1.2rem; font-weight: 700;" id="extract-btn">
          <i class="fas fa-play-circle"></i> Start Data Extraction
        </button>
        <div id="extraction-status" class="status-indicator status-inactive" style="margin-top: 15px;">
          <i class="fas fa-circle"></i> Extraction Inactive
        </div>
        <small class="helper" style="display: block; margin-top: 10px;">Ensure you're logged in and have selected at least one data source</small>
      </div>
    </form>

    <!-- Results Section -->
    <section class="results-section">
      <h2><i class="fas fa-database"></i> Extraction Results</h2>
      <div class="results-container">
        <table class="data-table">
          <thead>
            <tr>
              <th><i class="fas fa-phone"></i> Phone Number</th>
              <th><i class="fas fa-building"></i> Business Name</th>
              <th><i class="fas fa-map-marker-alt"></i> Address</th>
              <th><i class="fas fa-source"></i> Source</th>
            </tr>
          </thead>
          <tbody id="phone-preview">
            <tr>
              <td colspan="4" class="placeholder-msg">
                <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 15px; display: block; color: var(--gray);"></i>
                No data extracted yet<br>
                <small>Click "Start Data Extraction" to begin collecting business information</small>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="progress-stats">
        <div class="stats-group">
          <div class="stat-item">
            <i class="fas fa-database" style="color: var(--success);"></i>
            <span>Total Records: <strong id="number-count">0</strong></span>
          </div>
          <div class="stat-item">
            <i class="fas fa-clock" style="color: var(--info);"></i>
            <span>Last Update: <strong id="last-update">Never</strong></span>
          </div>
          <div class="stat-item">
            <i class="fas fa-plug" style="color: var(--warning);"></i>
            <span>Status: <strong id="connection-status">Ready</strong></span>
          </div>
        </div>
        <button class="btn outline-btn" onclick="clearResults()">
          <i class="fas fa-trash"></i> Clear Results
        </button>
      </div>
    </section>

    <!-- Live Extraction Panel -->
    <div class="extraction-panel">
      <h3><i class="fas fa-bolt"></i> Live Extraction Feed</h3>
      <div id="extraction-container">
        <div class="placeholder-msg">
          <i class="fas fa-satellite-dish" style="font-size: 2rem; margin-bottom: 10px; display: block; color: var(--info);"></i>
          Live extraction feed will appear here<br>
          <small>Real-time updates from selected data sources</small>
        </div>
      </div>
    </div>
  </div>

<script>
    // Enhanced global variables
    const countryStates = JSON.parse('{{ country_states | tojson | safe }}');
    let totalItems = 0;
    let userLoggedIn = false;
    let extractionActive = false;
    let lastUpdateTime = null;

    // Enhanced utility functions
    function getCSRFToken() {
        return $('meta[name="csrf-token"]').attr('content');
    }

    function showToast(message, type = 'success') {
        const toast = $('#toast');
        const icon = type === 'success' ? 'check-circle' : 
                    type === 'error' ? 'exclamation-triangle' : 
                    'info-circle';
        
        toast.removeClass('success error warning').addClass(type).html(`
            <i class="fas fa-${icon}"></i>
            <div>
                <strong>${type.charAt(0).toUpperCase() + type.slice(1)}</strong>
                <div style="font-size: 0.9em; opacity: 0.9;">${message}</div>
            </div>
        `).addClass('show');
        
        setTimeout(() => {
            toast.removeClass('show');
        }, 5000);
    }

    function updateExtractionStatus(active) {
        extractionActive = active;
        const statusElement = $('#extraction-status');
        const extractBtn = $('#extract-btn');
        
        if (active) {
            statusElement.html('<i class="fas fa-sync-alt fa-spin"></i> Extraction Active').removeClass('status-inactive').addClass('status-active');
            extractBtn.addClass('extracting-pulse').html('<div class="loading"></div> Extraction Running...').prop('disabled', true);
        } else {
            statusElement.html('<i class="fas fa-circle"></i> Extraction Inactive').removeClass('status-active').addClass('status-inactive');
            extractBtn.removeClass('extracting-pulse').html('<i class="fas fa-play-circle"></i> Start Data Extraction').prop('disabled', false);
        }
    }

    function updateLastUpdateTime() {
        lastUpdateTime = new Date();
        $('#last-update').text(lastUpdateTime.toLocaleTimeString());
    }

    // Enhanced session check
    function checkAuth() {
        return new Promise((resolve) => {
            // Try to access a protected endpoint to check authentication
            $.ajax({
                url: '/view-extraction',
                method: 'GET',
                success: function(data) {
                    userLoggedIn = true;
                    updateUI();
                    resolve(true);
                },
                error: function(xhr) {
                    if (xhr.status === 403) {
                        userLoggedIn = false;
                        updateUI();
                        resolve(false);
                    } else {
                        // Other error, assume not logged in
                        userLoggedIn = false;
                        updateUI();
                        resolve(false);
                    }
                }
            });
        });
    }

    function updateUI() {
        if (userLoggedIn) {
            $('#user-login-btn').hide();
            $('#user-logout-btn').show();
            $('.action-card').css('opacity', '1').css('cursor', 'pointer');
            $('#extraction-status').html('<i class="fas fa-check-circle"></i> Ready to Extract').removeClass('status-inactive').addClass('status-active');
        } else {
            $('#user-login-btn').show();
            $('#user-logout-btn').hide();
            $('.action-card').css('opacity', '0.7').css('cursor', 'not-allowed');
            $('#extraction-status').html('<i class="fas fa-exclamation-circle"></i> Login Required').removeClass('status-active').addClass('status-inactive');
        }
    }

    // Enhanced form handling functions
    function updateStates() {
        const country = $('#country').val();
        const stateSelect = $('#state');
        stateSelect.empty().append('<option value="">-- Select State --</option>');
        
        if (country && countryStates[country]) {
            countryStates[country].forEach(state => {
                stateSelect.append(`<option value="${state}">${state}</option>`);
            });
            stateSelect.prop('disabled', false);
        } else {
            stateSelect.prop('disabled', true);
        }
    }

    function exportData() {
        if (!userLoggedIn) {
            showToast('Please login to export data', 'error');
            $('#user-login-btn').click();
            return;
        }

        if (totalItems === 0) {
            showToast('No data available for export', 'warning');
            return;
        }
        
        showToast('Preparing export file...', 'info');
        setTimeout(() => {
            window.location.href = '/export-data?format=csv';
        }, 1000);
    }

    function clearResults() {
        if (!userLoggedIn) {
            showToast('Please login to manage results', 'error');
            return;
        }
        
        if (confirm('Are you sure you want to clear all extraction results? This action cannot be undone.')) {
            // Since /clear-results doesn't exist, we'll refresh the view
            showToast('Refreshing data view...', 'info');
            updateResults();
        }
    }

function updateResults() {
    if (!userLoggedIn) {
        return;
    }
    
    $.ajax({
        url: '/view-extraction?db=true',
        method: 'GET',
        success: function(data) {
            const container = $('#phone-preview');
            totalItems = data.total || 0;

            if (data.numbers && data.numbers.length > 0) {
                container.empty();
    
                // Show ALL results in reverse order (newest first)
                data.numbers.slice().reverse().forEach(entry => {
                    const sourceIcon = getSourceIcon(entry.source);
                    const sourceBadge = entry.source ? `<span class="status-indicator status-active" style="font-size: 0.7rem; padding: 2px 8px;">${sourceIcon} ${entry.source}</span>` : '';
        
                    container.append(`
                        <tr class="data-entry">
                            <td><i class="fas fa-phone" style="color: var(--success);"></i> ${entry.number || 'N/A'}</td>
                            <td><i class="fas fa-building" style="color: var(--primary);"></i> ${entry.name || 'N/A'}</td>
                            <td><i class="fas fa-map-marker-alt" style="color: var(--danger);"></i> ${entry.address || 'N/A'}</td>
                            <td>${sourceBadge}</td>
                        </tr>
                    `);
                });
    
                updateLastUpdateTime();
            }
            else if (totalItems === 0) {
                // No results found
                container.html(`
                    <tr>
                        <td colspan="4" class="placeholder-msg">
                            <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 15px; display: block; color: var(--gray);"></i>
                            No data extracted yet<br>
                            <small>Click "Start Data Extraction" to begin collecting business information</small>
                        </td>
                    </tr>
                `);
            } else if (extractionActive) {
                // Still extracting but no results yet
                container.html(`
                    <tr>
                        <td colspan="4" class="placeholder-msg">
                            <div class="loading" style="width: 30px; height: 30px; border-width: 4px;"></div>
                            <div style="margin-top: 15px;">Extraction in progress...</div>
                            <small>Scanning platforms for data. This may take a few minutes.</small>
                        </td>
                    </tr>
                `);
            }
            
            $('#number-count').text(totalItems);
            
            // Update connection status
            if (extractionActive) {
                $('#connection-status').html('<span style="color: var(--success);">Extracting</span>');
            } else if (totalItems > 0) {
                $('#connection-status').html('<span style="color: var(--info);">Ready</span>');
            } else {
                $('#connection-status').html('<span style="color: var(--warning);">Idle</span>');
            }
        },
        error: function(xhr) {
            if (xhr.status === 403) {
                userLoggedIn = false;
                updateUI();
                showToast('Session expired. Please login again.', 'error');
            } else {
                console.error('Failed to fetch results:', xhr);
            }
        }
    });
}

    function getSourceIcon(source) {
        const icons = {
            'yellowpages': 'fa-book',
            'whitepages': 'fa-book-open',
            'manta': 'fa-fish',
            'yelp': 'fa-utensils',
            'truepeoplesearch': 'fa-user',
            'spokeo': 'fa-search',
            'fastpeoplesearch': 'fa-bolt',
            'zabasearch': 'fa-globe',
            'mock': 'fa-test-tube'
        };
        return `<i class="fas ${icons[source] || 'fa-globe'}"></i>`;
    }

    // Enhanced startExtraction function
    function startExtraction() {
        if (!userLoggedIn) {
            showToast('Authentication required. Please login with your license key.', 'error');
            $('#user-login-btn').click();
            return;
        }

        const keywords = $('#keywords').val().trim();
        const location = $('#state').val() || $('#country').val() || '';
        const platforms = $('input[name="platforms[]"]:checked')
            .map(function() { return this.value; })
            .get();

        if (!keywords && !location) {
            showToast('Please provide either keywords or a location to search', 'warning');
            return;
        }

        if (platforms.length === 0) {
            showToast('Please select at least one data source platform', 'warning');
            return;
        }

        if (!$('#country').val()) {
            showToast('Please select a country for geographic targeting', 'warning');
            return;
        }

        const formData = new FormData();
        formData.append('keywords', keywords);
        formData.append('location', location);
        platforms.forEach(platform => {
            formData.append('platforms[]', platform);
        });
        formData.append('csrf_token', getCSRFToken());

        // Enhanced loading state
        const extractBtn = $('#extract-btn');
        extractBtn.prop('disabled', true).html(`<div class="loading"></div> Initializing Extraction...`);

        $.ajax({
            url: '/extract',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: { 'X-CSRFToken': getCSRFToken() },
            success: function(resp) {
                if (resp.status === 'Extraction started') {
                    updateExtractionStatus(true);
                    showToast(`Extraction started! Scanning ${platforms.length} platforms for data`, 'success');

                    $('#phone-preview').html(`
                        <tr>
                            <td colspan="4" class="placeholder-msg">
                                <div class="loading" style="width: 30px; height: 30px; border-width: 4px;"></div>
                                <div style="margin-top: 15px;">Extraction in progress...</div>
                                <small>Scanning: ${platforms.join(', ')}</small>
                            </td>
                        </tr>
                    `);

                    $('#extraction-container').html(`
                        <div class="placeholder-msg">
                            <div class="loading"></div>
                            <div>Extraction started successfully!</div>
                            <small>Results will appear in the table above</small>
                        </div>
                    `);

                    // Start polling for results
                    startResultsPolling();
                } else if (resp.error) {
                    showToast(resp.error, 'error');
                }
            },
            error: function(xhr) {
                let msg = 'Failed to start extraction';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    msg = xhr.responseJSON.error;
                }
                if (xhr.status === 403) {
                    userLoggedIn = false;
                    updateUI();
                    msg = 'Session expired. Please login again.';
                    showToast(msg, 'error');
                    $('#user-login-btn').click();
                } else {
                    showToast(msg, 'error');
                }
            },
            complete: function() {
                if (!extractionActive) {
                    extractBtn.prop('disabled', false).html('<i class="fas fa-play-circle"></i> Start Data Extraction');
                }
            }
        });
    }

    // Polling for results since SSE is not implemented
function startResultsPolling() {
    let pollCount = 0;
    const maxPolls = 300; // 5 minutes maximum (300 * 1000ms = 5 minutes)
    
    const pollInterval = setInterval(() => {
        pollCount++;
        
        if (!extractionActive || pollCount > maxPolls) {
            clearInterval(pollInterval);
            if (pollCount > maxPolls) {
                showToast('Extraction timeout reached', 'warning');
                updateExtractionStatus(false);
            }
            return;
        }
        
        updateResults();
        
    }, 1000); // Poll every second for better responsiveness
}

    // Enhanced License Login function
    function handleLicenseLogin(e) {
        e.preventDefault();

        const key = $('#license-key').val().trim().toUpperCase();
        const errorElement = $('#license-error');

        if (!key) {
            errorElement.html('<i class="fas fa-exclamation-circle"></i> License key is required');
            return;
        }

        errorElement.text('');
        const $btn = $('#license-form button');
        $btn.prop('disabled', true).html('<div class="loading"></div> Verifying License...');

        const formData = new FormData();
        formData.append('license_key', key);
        formData.append('csrf_token', getCSRFToken());

        $.ajax({
            url: '/user-login',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(resp) {
                if (resp.success) {
                    $('#license-login').fadeOut(300);
                    userLoggedIn = true;
                    updateUI();
                    showToast('License verified successfully! You can now start data extraction.', 'success');
                    $('#license-key').val('');
                    
                    // Auto-focus on keywords after successful login
                    setTimeout(() => {
                        $('#keywords').focus();
                    }, 500);
                    
                    // Refresh results after a short delay
                    setTimeout(() => {
                        updateResults();
                    }, 1000);
                } else {
                    errorElement.html(`<i class="fas fa-times-circle"></i> ${resp.error || 'Invalid license key'}`);
                }
            },
            error: function(xhr) {
                let msg = 'Login failed. Please check your connection and try again.';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    msg = xhr.responseJSON.error;
                }
                errorElement.html(`<i class="fas fa-exclamation-triangle"></i> ${msg}`);
            },
            complete: function() {
                $btn.prop('disabled', false).html('<i class="fas fa-sign-in-alt"></i> Login & Start Extracting');
            }
        });
    }

    function stopExtraction() {
        if (!userLoggedIn) {
            showToast('Please login first', 'error');
            return;
        }

        if (!extractionActive) {
            showToast('No extraction is currently running', 'warning');
            return;
        }

        if (!confirm('Are you sure you want to stop the current extraction?')) {
            return;
        }

        const formData = new FormData();
        formData.append('csrf_token', getCSRFToken()); // Add CSRF token
    
        $.ajax({
            url: '/stop-extraction',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {'X-CSRFToken': getCSRFToken()},
            success: function() {
                updateExtractionStatus(false);
                updateResults();
                showToast('Extraction stopped successfully', 'info');
            },
            error: function(xhr) {
                let errorMsg = 'Failed to stop extraction';
                if (xhr.responseJSON && xhr.responseJSON.error) errorMsg = xhr.responseJSON.error;
                showToast(errorMsg, 'error');
            }
        });
    }

    function handleUserLogout() {
        // Since /user-logout doesn't exist, we'll clear the frontend session
        userLoggedIn = false;
        updateUI();
        if (extractionActive) {
            showToast('Please stop extraction before logging out', 'warning');
            return;
        }
        showToast('Logged out successfully', 'info');
        updateResults();
        
        // Clear any stored form data
        localStorage.removeItem('extractionFormData');
    }

    // Enhanced document ready
    $(document).ready(function() {
        console.log('Data Extractor UI initializing...');
        
        // Initialize page
        $('#country').on('change', updateStates);

        // Set initial UI state
        userLoggedIn = false;
        updateUI();

        // Don't automatically check auth on page load to avoid 403 errors
        // Let the user login first

        // Enhanced modal handlers
        $('#user-login-btn').on('click', function() {
            $('#license-login').fadeIn(300);
            $('#license-key').focus();
        });

        $('#license-login').on('click', function(e) {
            if (e.target === this) $(this).fadeOut(300);
        });

        $('.close-modal').on('click', function() {
            $('#license-login').fadeOut(300);
        });

        $(document).on('keydown', function(e) {
            if (e.key === "Escape") {
                $('#license-login').fadeOut(300);
            }
        });

        // Enhanced form submissions
        $('#license-form').on('submit', handleLicenseLogin);
        $('#user-logout-btn').on('click', handleUserLogout);

        // Auto-save form data (only when logged in)
        setInterval(function() {
            if (userLoggedIn) {
                const formData = {
                    keywords: $('#keywords').val(),
                    location: $('#country').val(),
                    platforms: $('input[name="platforms[]"]:checked').map(function() { return this.value; }).get()
                };
                localStorage.setItem('extractionFormData', JSON.stringify(formData));
            }
        }, 5000);

        // Load saved form data (only when logged in)
        const savedData = localStorage.getItem('extractionFormData');
        if (savedData && userLoggedIn) {
            const data = JSON.parse(savedData);
            $('#keywords').val(data.keywords || '');
            $('#country').val(data.location || '').trigger('change');
            if (data.platforms) {
                $('input[name="platforms[]"]').prop('checked', false);
                data.platforms.forEach(platform => {
                    $(`input[name="platforms[]"][value="${platform}"]`).prop('checked', true);
                });
            }
        }

        // Enhanced periodic checks (only when logged in)
        setInterval(function() {
            if (userLoggedIn) {
                checkAuth();
            }
        }, 120000);
        
        // Enhanced auto-update (only when logged in and extraction active)
        setInterval(function() {
            if (userLoggedIn && extractionActive) {
                updateResults();
            }
        }, 8000);

        // Add keyboard shortcuts
        $(document).on('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'Enter':
                        e.preventDefault();
                        if (userLoggedIn) {
                            startExtraction();
                        } else {
                            $('#user-login-btn').click();
                        }
                        break;
                    case 'l':
                        e.preventDefault();
                        $('#user-login-btn').click();
                        break;
                    case 'e':
                        e.preventDefault();
                        if (userLoggedIn) {
                            exportData();
                        }
                        break;
                }
            }
        });

        console.log('Data Extractor UI initialized successfully');
    });
</script>
</body>
</html>