<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="csrf-token" content="{{ csrf_token() }}">
  <title>Professional Data Extractor</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    /* ... (keep existing styles) ... */
  </style>
</head>
<body>
  <div class="container">
    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <header class="main-header">
      <h1><i class="fas fa-search"></i> Professional Data Extractor</h1>
      <div class="header-controls">
        <button class="btn success-btn" onclick="exportData()">
          <i class="fas fa-download"></i> Export CSV
        </button>
        <button class="btn danger-btn" onclick="stopExtraction()">
          <i class="fas fa-stop"></i> Stop Extraction
        </button>
        <a href="{{ url_for('admin_login') }}" class="btn admin-btn" target="_blank">
          <i class="fas fa-cog"></i> Admin Panel
        </a>
        <button class="btn primary-btn" id="user-login-btn">
          <i class="fas fa-key"></i> User Login
        </button>
        <button class="btn warning-btn" id="user-logout-btn" style="display:none;">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </header>

    <!-- License Login Modal -->
    <div id="license-login" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2><i class="fas fa-key"></i> User License Login</h2>
          <button class="close-modal">&times;</button>
        </div>
        <form id="license-form">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="input-group">
            <label for="license-key">Enter Your License Key:</label>
            <input type="text" id="license-key" name="license_key" placeholder="XXXX-XXXX-XXXX-XXXX" required>
          </div>
          <button type="submit" class="btn primary-btn" style="width: 100%;">
            <i class="fas fa-sign-in-alt"></i> Login
          </button>
        </form>
        <div id="license-error" style="color: var(--danger); margin-top: 10px; text-align: center;"></div>
      </div>
    </div>

    <!-- Main Form -->
    <form method="POST" id="phone-extractor-form">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <div class="form-section">
        <div class="input-group">
          <label for="urls"><i class="fas fa-link"></i> Enter URLs (optional):</label>
          <textarea name="urls" id="urls" placeholder="Optional: Enter specific URLs separated by commas"></textarea>
          <small class="helper">Leave blank to let the scraper search the selected sites automatically.</small>
        </div>
        <div class="input-group">
          <label for="keywords"><i class="fas fa-key"></i> Keywords (optional):</label>
          <textarea name="keywords" id="keywords" placeholder="Keywords, categories or business names (optional)"></textarea>
        </div>
      </div>

      <div class="form-section">
        <label><i class="fas fa-sitemap"></i> Select Source Sites:</label>
        <div class="checkbox-group">
          <label><input type="checkbox" name="platforms[]" value="yellowpages"> <i class="fas fa-book"></i> Yellow Pages</label>
          <label><input type="checkbox" name="platforms[]" value="whitepages"> <i class="fas fa-book-open"></i> Whitepages</label>
          <label><input type="checkbox" name="platforms[]" value="manta"> <i class="fas fa-fish"></i> Manta</label>
          <label><input type="checkbox" name="platforms[]" value="yelp"> <i class="fas fa-utensils"></i> Yelp</label>
          <label><input type="checkbox" name="platforms[]" value="411"> <i class="fas fa-phone"></i> 411</label>
          <label><input type="checkbox" name="platforms[]" value="local_com"> <i class="fas fa-map-marker-alt"></i> Local.com</label>
          <label><input type="checkbox" name="platforms[]" value="foursquare"> <i class="fas fa-square"></i> Foursquare</label>
        </div>
      </div>

      <div class="form-section">
        <div class="input-group">
          <label for="country"><i class="fas fa-globe"></i> Select Country:</label>
          <select id="country" name="country">
            <option value="">-- Select Country --</option>
            {% for country in countries %}
              <option value="{{ country }}">{{ country }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="input-group">
          <label for="state"><i class="fas fa-map"></i> Select State / Region (optional):</label>
          <select id="state" name="state">
            <option value="">-- Select State --</option>
          </select>
        </div>
      </div>
      
      <div class="form-section">
          <div class="input-group">
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                  <input type="checkbox" id="continuous-mode" name="continuous" value="true">
                  <span><i class="fas fa-sync-alt"></i> Continuous Extraction Mode</span>
              </label>
              <small class="helper">When enabled, extraction will continue running until manually stopped. Data will be accumulated across iterations.</small>
          </div>
      </div>

      <div class="form-section" style="text-align: center;">
        <button type="button" class="btn primary-btn" onclick="startExtraction()" style="padding: 12px 30px; font-size: 1.1rem;">
          <i class="fas fa-play"></i> Start Extraction
        </button>
        <div id="extraction-status" class="status-indicator status-inactive" style="margin-top: 10px;">
          <i class="fas fa-circle"></i> Extraction Inactive
        </div>
      </div>
    </form>

    <!-- Results Section -->
    <section class="results-section">
      <h2><i class="fas fa-list"></i> Live Extraction Results</h2>
      <div class="results-container">
        <table class="data-table">
          <thead>
            <tr>
              <th>Phone Number</th>
              <th>Full Name</th>
              <th>Address</th>
              <th>Source</th>
            </tr>
          </thead>
          <tbody id="phone-preview">
            <tr>
              <td colspan="4" class="placeholder-msg">No data extracted yet. Click "Start Extraction" to begin.</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="progress-stats">
        <p><i class="fas fa-database"></i> Records found: <span id="number-count">0</span></p>
      </div>
    </section>

    <!-- Live Extraction Panel -->
    <div class="extraction-panel">
      <h3><i class="fas fa-bolt"></i> Live Extraction Feed</h3>
      <div id="extraction-container">
        <div class="placeholder-msg">Live extraction results will appear here</div>
      </div>
    </div>
  </div>

<script>
    // Global variables
    const countryStates = JSON.parse('{{ country_states | tojson | safe }}');
    let totalItems = 0;
    let userLoggedIn = false;
    let extractionActive = false;
    let eventSource = null;

    // Utility functions
    function getCSRFToken() {
        return $('meta[name="csrf-token"]').attr('content');
    }

    function showToast(message, type = 'success') {
        const toast = $('#toast');
        toast.removeClass('success error warning').addClass(type).html(`
            <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
            ${message}
        `).addClass('show');
        
        setTimeout(() => {
            toast.removeClass('show');
        }, 4000);
    }

    function updateExtractionStatus(active) {
        extractionActive = active;
        const statusElement = $('#extraction-status');
        if (active) {
            statusElement.html('<i class="fas fa-sync-alt fa-spin"></i> Extraction Active').removeClass('status-inactive').addClass('status-active');
        } else {
            statusElement.html('<i class="fas fa-circle"></i> Extraction Inactive').removeClass('status-active').addClass('status-inactive');
        }
    }

    // Simple session check
    function checkAuth() {
        return $.get('/check-auth')
            .done(function(data) {
                userLoggedIn = data.authenticated;
                updateUI();
                return userLoggedIn;
            })
            .fail(function() {
                userLoggedIn = false;
                updateUI();
                return false;
            });
    }

    function updateUI() {
        if (userLoggedIn) {
            $('#user-login-btn').hide();
            $('#user-logout-btn').show();
        } else {
            $('#user-login-btn').show();
            $('#user-logout-btn').hide();
        }
    }

    // Form handling functions
    function updateStates() {
        const country = $('#country').val();
        const stateSelect = $('#state');
        stateSelect.empty().append('<option value="">-- Select State --</option>');
        
        if (country && countryStates[country]) {
            countryStates[country].forEach(state => {
                stateSelect.append(`<option value="${state}">${state}</option>`);
            });
        }
    }

    function exportData() {
        if (totalItems === 0) {
            showToast('No data to export', 'warning');
            return;
        }
        if (!userLoggedIn) {
            showToast('Please login first', 'error');
            return;
        }
        window.location.href = '/export-data?format=csv';
    }

    function updateResults() {
        $.get('/view-extraction')
            .done(function(data) {
                if (data.error && data.error === "Authentication required") {
                    userLoggedIn = false;
                    updateUI();
                    showToast('Please login to view results', 'error');
                    return;
                }

                const container = $('#phone-preview');
                container.empty();
                totalItems = data.total || 0;

                if (data.numbers && data.numbers.length > 0) {
                    data.numbers.slice(-50).forEach(entry => {
                        const sourceBadge = entry.source ? `<span class="status-indicator status-active" style="font-size: 0.7rem; padding: 2px 6px;">${entry.source}</span>` : '';
                        container.append(`
                            <tr class="data-entry">
                                <td><i class="fas fa-phone"></i> ${entry.number}</td>
                                <td><i class="fas fa-user"></i> ${entry.name || 'N/A'}</td>
                                <td><i class="fas fa-map-marker-alt"></i> ${entry.address || 'N/A'}</td>
                                <td>${sourceBadge}</td>
                            </tr>
                        `);
                    });
                    
                    if (data.numbers.length > 50) {
                        container.append(`
                            <tr>
                                <td colspan="4" class="placeholder-msg">
                                    <i class="fas fa-info-circle"></i> Showing last 50 of ${data.numbers.length} records
                                </td>
                            </tr>
                        `);
                    }
                } else {
                    container.append(`
                        <tr>
                            <td colspan="4" class="placeholder-msg">No data extracted yet. Click "Start Extraction" to begin.</td>
                        </tr>
                    `);
                }
                $('#number-count').text(totalItems);
            })
            .fail(function(xhr) {
                if (xhr.status === 403) {
                    userLoggedIn = false;
                    updateUI();
                    showToast('Session expired. Please login again.', 'error');
                } else {
                    showToast('Failed to fetch results', 'error');
                }
            });
    }

    // Enhanced startExtraction function
    function startExtraction() {
        if (!userLoggedIn) {
            showToast('You must login with a valid license first!', 'error');
            $('#user-login-btn').click();
            return;
        }

        const keywords = $('#keywords').val().trim();
        const location = $('#state').val() || $('#country').val() || '';
        const platforms = $('input[name="platforms[]"]:checked')
            .map(function() { return this.value; })
            .get();

        if (!keywords && !location) {
            showToast('Please provide either keywords or a location', 'warning');
            return;
        }

        if (platforms.length === 0) {
            showToast('Please select at least one platform', 'warning');
            return;
        }

        const formData = new FormData();
        formData.append('keywords', keywords);
        formData.append('location', location);
        platforms.forEach(platform => {
            formData.append('platforms[]', platform);
        });
        formData.append('csrf_token', getCSRFToken());

        // Show loading state
        const extractBtn = $('.primary-btn');
        extractBtn.prop('disabled', true).html(`<div class="loading"></div> Starting extraction...`);

        $.ajax({
            url: '/extract',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: { 'X-CSRFToken': getCSRFToken() },
            success: function(resp) {
                if (resp.status === 'Extraction started') {
                    updateExtractionStatus(true);
                    startEventStream();
                    showToast(`Extraction started! Scanning: ${platforms.join(', ')}`);

                    $('#phone-preview').html(`
                        <tr>
                            <td colspan="4" class="placeholder-msg">
                                <div class="loading"></div> Extraction in progress... 
                        <br><small>Live results will appear below and in the extraction feed</small>
                            </td>
                        </tr>
                    `);

                    $('#extraction-container').html(`
                        <div class="placeholder-msg">
                            <div class="loading"></div> 
                            <div>Starting real-time extraction...</div>
                            <small>Monitoring: ${platforms.join(', ')}</small>
                        </div>
                    `);
                } else if (resp.error) {
                    showToast(resp.error, 'error');
                }
            },
            error: function(xhr) {
                let msg = 'Failed to start extraction';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    msg = xhr.responseJSON.error;
                }
                if (xhr.status === 403) {
                    userLoggedIn = false;
                    updateUI();
                    msg = 'Session expired. Please login again.';
                }
                showToast(msg, 'error');
            },
            complete: function() {
                extractBtn.prop('disabled', false).html('<i class="fas fa-play"></i> Start Extraction');
            }
        });
    }

    // Event Stream function - FIXED
    function startEventStream() {
        if (eventSource) {
            eventSource.close();
        }
        
        eventSource = new EventSource('/stream-extraction');
        const container = $('#extraction-container');
        
        eventSource.onopen = function() {
            console.log('SSE connection established');
            container.html('<div class="placeholder-msg"><div class="loading"></div> Connected, waiting for data...</div>');
        };
        
        eventSource.onmessage = function(e) {
            const data = e.data;
            
            if (data === 'END:stopped') {
                eventSource.close();
                updateExtractionStatus(false);
                showToast('Extraction completed!');
                updateResults();
                return;
            }
            
            if (data.startsWith('COUNT:')) {
                const count = data.split(':')[1];
                $('#number-count').text(count);
                return;
            }
            
            // Handle JSON data
            try {
                const item = JSON.parse(data);
                
                if (item.error) {
                    // Show error in feed
                    const errorItem = $(`<div class="extracted-item" style="color: var(--danger);"></div>`).html(`
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div>${item.error}</div>
                        </div>
                    `);
                    errorItem.hide().prependTo(container).fadeIn(300);
                    return;
                }
                
                if (item.info) {
                    // Show info message
                    const infoItem = $(`<div class="extracted-item" style="color: var(--info);"></div>`).html(`
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-info-circle"></i>
                            <div>${item.info}</div>
                        </div>
                    `);
                    infoItem.hide().prependTo(container).fadeIn(300);
                    return;
                }
                
                // Regular data item
                const timestamp = new Date().toLocaleTimeString();
                const sourceBadge = item.source ? `<span class="status-indicator status-active" style="font-size: 0.7rem; padding: 2px 6px;">${item.source}</span>` : '';
                
                const dataItem = $(`<div class="extracted-item"></div>`).html(`
                    <div style="display: flex; align-items: flex-start; gap: 10px; flex-wrap: wrap; width: 100%;">
                        <div style="flex-shrink: 0;">
                            <i class="fas fa-phone text-success"></i> <strong>${item.number}</strong> ${sourceBadge}
                            <br><small style="color: #666;">${timestamp}</small>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <div><small><i class="fas fa-user"></i> ${item.name}</small></div>
                            <div><small><i class="fas fa-map-marker-alt"></i> ${item.address}</small></div>
                        </div>
                    </div>
                `);
                
                dataItem.hide().prependTo(container).fadeIn(300);
                
                // Limit container size
                if (container.children().length > 100) {
                    container.children().last().remove();
                }
                
                // Update results table periodically
                if (container.children().length % 5 === 0) {
                    updateResults();
                }
                
            } catch (e) {
                // Not JSON, ignore
                console.log('Non-JSON SSE data:', data);
            }
        };
        
        eventSource.onerror = function(err) {
            console.error('EventSource error:', err);
            if (eventSource) {
                eventSource.close();
            }
            updateExtractionStatus(false);
            showToast('Connection to extraction stream lost', 'error');
        };
    }

    // License Login function - FIXED
    function handleLicenseLogin(e) {
        e.preventDefault();

        const key = $('#license-key').val().trim();
        const errorElement = $('#license-error');

        if (!key) {
            errorElement.text('License key is required');
            return;
        }

        errorElement.text('');
        const $btn = $('#license-form button');
        $btn.prop('disabled', true).html('<div class="loading"></div> Verifying...');

        // Create form data properly
        const formData = new FormData();
        formData.append('license_key', key);
        formData.append('csrf_token', getCSRFToken());

        $.ajax({
            url: '/user-login',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(resp) {
                if (resp.success) {
                    $('#license-login').fadeOut(300);
                    userLoggedIn = true;
                    updateUI();
                    showToast('License verified! You can now start extraction.');
                    $('#license-key').val(''); // Clear the input
                    
                    // Refresh results after successful login
                    setTimeout(updateResults, 500);
                } else {
                    errorElement.text(resp.error || 'Invalid license key.');
                }
            },
            error: function(xhr) {
                let msg = 'Login failed. Please try again.';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    msg = xhr.responseJSON.error;
                }
                errorElement.text(msg);
            },
            complete: function() {
                $btn.prop('disabled', false).html('<i class="fas fa-sign-in-alt"></i> Login');
            }
        });
    }

    function stopExtraction() {
        if (!extractionActive) {
            showToast('No extraction is currently running', 'warning');
            return;
        }

        const formData = new FormData();
        formData.append('csrf_token', getCSRFToken());
        
        $.ajax({
            url: '/stop-extraction',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {'X-CSRFToken': getCSRFToken()},
            success: function() {
                if (eventSource) eventSource.close();
                updateExtractionStatus(false);
                updateResults();
                showToast('Extraction stopped successfully!');
            },
            error: function(xhr) {
                let errorMsg = 'Failed to stop extraction';
                if (xhr.responseJSON && xhr.responseJSON.error) errorMsg = xhr.responseJSON.error;
                showToast(errorMsg, 'error');
            }
        });
    }

    function handleUserLogout() {
        const formData = new FormData();
        formData.append('csrf_token', getCSRFToken());
        
        $.ajax({
            url: '/user-logout',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(resp) {
                if (resp.success) {
                    userLoggedIn = false;
                    updateUI();
                    if (extractionActive) stopExtraction();
                    showToast('Logged out successfully!');
                    updateResults();
                }
            },
            error: function() {
                showToast('Logout failed', 'error');
            }
        });
    }

    // Document ready
    $(document).ready(function() {
        // Initialize page
        $('#country').on('change', updateStates);

        // Check auth status on page load
        checkAuth().then(function() {
            updateResults();
        });

        // Modal handlers
        $('#user-login-btn').on('click', function() {
            $('#license-login').fadeIn(300);
            $('#license-key').focus();
        });

        $('#license-login').on('click', function(e) {
            if (e.target === this) $(this).fadeOut(300);
        });

        $('.close-modal').on('click', function() {
            $('#license-login').fadeOut(300);
        });

        $(document).on('keydown', function(e) {
            if (e.key === "Escape") {
                $('#license-login').fadeOut(300);
            }
        });

        // Form submissions
        $('#license-form').on('submit', handleLicenseLogin);
        $('#user-logout-btn').on('click', handleUserLogout);

        // Check auth every 2 minutes
        setInterval(checkAuth, 120000);
        
        // Auto-update results every 10 seconds when extraction is active
        setInterval(function() {
            if (extractionActive) {
                updateResults();
            }
        }, 10000);
    });
</script>
</body>
</html>